    <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- No <title> needed if you don’t want any page title shown -->
 <style>
    body {
        margin: 0;
        padding: 20px;
        background: #f5f5f5;
        min-height: 100vh;
        font-family: Arial, Helvetica, sans-serif;
        /* ← Removed display:flex from body → normal vertical flow restored */
    }

    .score-board {
        width: 100%;
        max-width: 900px;
        margin: 0 auto 30px auto;   /* centers the whole scoreboard */
    }

    /* Your perfect horizontal score line */
    .single-score-line {
        display: flex;
        justify-content: center;
        align-items: baseline;
        gap: 28px;
        padding: 18px 24px;
        background: white;
        color: black;
        font-size: 1.9rem;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        flex-wrap: nowrap;
        white-space: nowrap;
    }

    .game-dropdown {
        background: transparent;
        color: black;
        border: 2px solid #333;
        border-radius: 6px;
        font-size: 1.2rem;
        padding: 6px 10px;
        cursor: pointer;
        font-weight: bold;
    }

    .team-label, .outs-label {
        font-size: 2.5rem;
        font-weight: bold;
        margin-right: 10px;
    }

    .score, .outs-count {
        font-size: 2.4rem;
        font-weight: bold;
    
    }

    .inning-section {
        font-size: 1.rem;
         font-weight: bold;
    }
    .inning-section #inning {
        font-weight: bold;
        font-size: 1.2rem;
    }

    /* Mobile tweaks for the score line */
    @media (max-width: 640px) {
        .single-score-line {
            gap: 14px;
            padding: 12px;
            font-size: 1.1rem;
        }
        .team-label, .outs-label { font-size: 1.4rem; }
        .score, .outs-count { font-size:2.4rem; }
        .game-dropdown { font-size: 1.1rem; padding: 4px 8px; }
    }

    /* ——— ALL YOUR OTHER STYLES (player-info, bases, controls, etc.) go here ——— */
    /* (just paste everything from .player-info down to the end of your original styles) */

    .player-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 20px 0;
        font-size: clamp(1rem, 3.5vw, 1.8em);
        font-weight: bold;
        color: #222;
        flex-wrap: wrap;
        gap: 10px;
    }
    /* … keep every single rule you had below this point exactly as-is … */
    /* (all the .bases, .controls, .inning-chart, .modal, etc.) */

        }
        .player-block {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-width: 200px;
        }
        .player-name {
            font-size: clamp(1.3rem, 5vw, 2.1em);
            font-weight: bold;
            margin-bottom: 6px;
        }
        .player-name.offense {
            color: #04662a;
        }
        .player-name.defense {
            color: #7a1313;
        }
        .player-index {
            font-size: .6em;
            color: #888;
            font-weight: normal;
            margin-left: 6px;
        }
        .player-meta {
            margin-top: 6px;
            font-size: .95rem;
            font-weight: 700;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        .player-name.active-player {
            background: #2e8b57;
            padding: 2px 6px;
            border-radius: 4px;
            color: #fff;
        }
        .player-meta .team, .player-meta .status {
            padding: 4px 8px;
            border-radius: 999px;
            font-weight: 700;
        }
        .meta-green .team, .meta-green .status {
            background: #dff7e6;
            color: #04662a;
            border: 1px solid #9ee0a8;
        }
        .meta-red .team, .meta-red .status {
            background: #ffe6e6;
            color: #7a1313;
            border: 1px solid #ffb3b3;
        }
        .meta-info {
            background: #eef6ff;
            color: #0b4d8a;
            border: 1px solid #cfe6ff;
            padding: 4px 8px;
            border-radius: 8px;
            font-weight: 700;
        }
        .bases {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
            font-size: 20px;
            font-weight: bold;
            position: relative;
        }
        .base {
            width: 70px;
            height: 70px;
            line-height: 70px;
            border-radius: 50%;
            background: #ffc107;
            color: #000;
            text-align: center;
            font-size: 1.4em;
            font-weight: bold;
            position: relative;
            transition: all .2s;
            border: 3px solid #e0a800;
        }
        .base.occupied {
            background: #a8e6a1 !important;
            border-color: #7bc96f;
        }
        .base .player-label {
            position: absolute;
           top: -40px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.8em;
            color: #000;
            font-weight: bold;
        }
        .base.home-plate {
            font-size: 1.5em;
            line-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 0 10px;
        }
        .base.home-plate .run-label {
            font-size: 1.5em;
            font-weight: bold;
            color: #000;
        }
        .base.home-plate.scored {
            background: #ffc107 !important;
            border-color: #e0a800 !important;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 8px;
            margin: 20px 0;
        }
        .controls button {
            padding: 14px 8px;
            font-size: .9rem;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all .2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .hit {
            background: #28a745;
            color: #fff;
        }
        .hit:hover {
            background: #218838;
        }
        .out {
            background: #dc3545;
            color: #fff;
        }
        .out:hover {
            background: #c82333;
        }
        .strike {
            background: #6f42c1;
            color: #fff;
        }
        .strike:hover {
            background: #5a32a3;
        }
        .error {
            background: #ff9800;
            color: #fff;
        }
        .error:hover {
            background: #e68a00;
        }
        .blue-btn {
            background: #007bff;
            color: #fff;
        }
        .blue-btn:hover {
            background: #0056b3;
        }
        .yellow-btn {
            background: #ffc107;
            color: #000;
        }
        .yellow-btn:hover {
            background: #e0a800;
        }
        .miss-btn {
            background: #6c757d;
            color: #fff;
        }
        .miss-btn:hover {
            background: #545b62;
        }
        .ball-btn {
            background: #6c757d;
            color: #fff;
        }
        .ball-btn:hover {
            background: #545b62;
        }
        .brown-btn {
            background: #8B4513;
            color: #fff;
        }
        .brown-btn:hover {
            background: #654321;
        }
        .green-btn {
            background: #28a745;
            color: #fff;
        }
        .green-btn:hover {
            background: #218838;
        }
        .action-btns {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .reset {
            background: #6c757d;
            color: #fff;
        }
        .reset:hover {
            background: #545b62;
        }
        .undo {
            background: #ff9800;
            color: #fff;
        }
        .undo:hover {
            background: #e68a00;
        }
        .confirm {
            background: #17a2b8;
            color: #fff;
            grid-column: span 3;
            font-size: 1.3em;
            font-weight: bold;
            padding: 20px 10px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        .confirm:hover {
            background: #138496;
        }
        .pending-play {
            margin: 15px 0;
            padding: 12px;
            background: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.3em;
            text-align: center;
            display: none;
        }
        .inning-chart {
            margin: 20px 0;
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,.1);
            overflow-x: auto;
        }
        .inning-chart table {
            width: 100%;
            border-collapse: collapse;
            font-size: .9em;
        }
        .inning-chart th, .inning-chart td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            min-width: 40px;
        }
        .inning-chart th {
            background: #007bff;
            color: #fff;
        }
        .inning-chart tr:nth-child(even) {
            background: #f8f9fa;
        }
        .links {
            margin: 10px 0;
            font-size: 1.1em;
            text-align: center;
        }
        .links a {
            margin: 0 10px;
            color: #007bff;
            text-decoration: none;
        }
        .links a:hover {
            text-decoration: underline;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, .5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 2px 10px rgba(0,0,0,.3);
        }
        .modal-content h3 {
            margin-bottom: 10px;
        }
        .modal-content p {
            font-size: 1.1em;
            margin: 10px 0;
        }
        .modal-content button {
            margin: 10px 5px;
            padding: 12px 20px;
            font-size: 1em;
            border-radius: 6px;
            cursor: pointer;
        }
        .load-lineup, .edit-lineup {
            background: #007bff;
            color: #fff;
            padding: 12px 24px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            min-width: 180px;
            margin: 10px auto;
            display: block;
        }
        .load-lineup:hover, .edit-lineup:hover {
            background: #0056b3;
        }
        .game-select select {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #d6e0ef;
            background: #fff;
            font-size: 1em;
        }
        @media (max-width: 720px) {
            .inning-header {
                flex-direction: column;
                white-space: normal;
            }
            .player-info {
                flex-direction: column;
                align-items: stretch;
            }
            .player-block {
                align-items: flex-start;
            }
            .controls {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            }
            .modal-content {
                max-width: 90%;
            }
        }

@media (max-width: 720px) {
    .single-score-line {
        flex-wrap: wrap;
        gap: 10px 16px;
        padding: 14px 12px;
        font-size: 1.4rem !important;
        text-align: center;
    }
    .team-label, .outs-label { font-size: 1.8rem !important; }
    .score, .outs-count { font-size: 2.2rem !important; }
    .inning-section { font-size: 1.3rem !important; }
    .game-dropdown { font-size: 1.1rem; padding: 6px 8px; }
}

@media (max-width: 480px) {
    .single-score-line {
        font-size: 1.2rem !important;
        gap: 8px 12px;
    }
    .team-label, .outs-label { font-size: 1.6rem !important; }
    .score, .outs-count { font-size: 2rem !important; }

    /* Make all buttons huge and easy to tap */
    .controls button, .action-btns button, .confirm {
        padding: 16px 10px !important;
        font-size: 1rem !important;
        min-height: 56px;
    }
    
    /* Inning chart: stack columns on tiny screens */
    .inning-chart table { font-size: 0.8rem; }
    .inning-chart th, .inning-chart td { padding: 6px 4px; min-width: 32px; }
}


    </style>
</head>
<body>

    <div class="score-board">
        <div class="single-score-line">

            <!-- Game # dropdown -->
            <select id="gameSelect" class="game-dropdown">
                <option value="1">Game 1</option>
                <option value="2">Game 2</option>
                <option value="3">Game 3</option>
                <!-- add more games here -->
            </select>

            <!-- Team A -->
            <span class="team-a">
                <span class="team-label">Team A</span>
                <span class="score" id="teamA-score">5</span>
            </span>

            <!-- Outs -->
            <span class="outs-section">
                <span class="outs-label">Outs</span>
                <span class="outs-count" id="outs">2</span>
            </span>

            <!-- Team B -->
            <span class="team-b">
                <span class="team-label">Team B</span>
                <span class="score" id="teamB-score">3</span>
            </span>

            <!-- Inning -->
            <span class="inning-section">
                <span id="half">Top</span>
                <span id="inning">9</span>
            </span>
        </div>
    </div>


        <div class="player-info">
            <div class="player-block" id="offense-block">
                <div>
                    <span class="player-name" id="batter-name">Player</span>
                    <span class="player-index"><span id="batter-index">1</span>/<span id="roster-size">3</span></span>
                </div>
                <div id="batter-meta" class="player-meta" aria-live="polite"></div>
            </div>

            <div class="player-block" id="defense-block">
                <div>
                    <span class="player-name" id="defender-name">Player</span>
                    <span class="player-index"><span id="defender-index">1</span>/<span id="defender-roster-size">3</span></span>
                </div>
                <div id="defender-meta" class="player-meta" aria-live="polite"></div>
            </div>
        </div>

        <div class="bases">
            <div class="base" id="first">1B<span class="player-label" id="first-player"></span></div>
            <div class="base" id="second">2B<span class="player-label" id="second-player"></span></div>
            <div class="base" id="third">3B<span class="player-label" id="third-player"></span></div>
            <div class="base home-plate" id="home-plate">HR <span class="run-label" id="home-runs" aria-live="polite">0</span></div>
        </div>

        <div id="pending-play" class="pending-play"></div>

        <div class="controls" id="batter-controls">
            <button type="button" class="brown-btn" onclick="queuePlay('1st')">1st Base</button>
            <button type="button" class="brown-btn" onclick="queuePlay('2nd')">2nd Base</button>
            <button type="button" class="brown-btn" onclick="queuePlay('3rd')">3rd Base</button>
            <button type="button" class="brown-btn" onclick="queuePlay('HR')">Homerun</button>
            <button type="button" class="brown-btn" onclick="queuePlay('H&R')">Hit & Run</button>
            <button type="button" class="ball-btn" onclick="queuePlay('Ball')">Ball</button>
            <button type="button" class="green-btn" onclick="queuePlay('Green')">Green</button>
            <button type="button" class="out" onclick="queuePlay('Red')">Red</button>
            <button type="button" class="blue-btn" onclick="queuePlay('Blue')">Blue</button>
            <button type="button" class="yellow-btn" onclick="queuePlay('Yellow')">Yellow</button>
        </div>
        <div class="controls" id="defender-controls" style="display: none;">
            <button type="button" class="blue-btn" id="defender-blue-btn" onclick="queuePlay('DefenderBlue')">Blue</button>
            <button type="button" class="yellow-btn" id="defender-yellow-btn" onclick="queuePlay('DefenderYellow')">Yellow</button>
            <button type="button" class="miss-btn" id="defender-miss-btn" onclick="queuePlay('DefenderMiss')">Miss</button>
        </div>

        <div class="action-btns">
            <button type="button" class="confirm" onclick="confirmPlay()">CONFIRM PLAY</button>
        </div>

        <div class="action-btns" style="margin-top: 15px; grid-template-columns: repeat(3, 1fr);">
            <button type="button" class="undo" onclick="showUndoModal()">Undo Last</button>
            <button type="button" class="reset" onclick="showClearModal()">Clear Inning</button>
            <button type="button" onclick="prevBatter()">Prev Batter</button>
            <button type="button" onclick="nextBatter()">Next Batter</button>
            <button type="button" onclick="prevDefender()">Prev Defender</button>
            <button type="button" onclick="nextDefender()">Next Defender</button>
            <button type="button" class="reset" onclick="showResetModal()">New Game</button>
            <button type="button" class="edit-lineup" onclick="editLineup()">Edit Lineup</button>
            <button type="button" class="load-lineup" onclick="loadLineup()">Load Lineup</button>
        </div>
    </div>

    <div class="inning-chart">
        <h3>Inning Scores</h3>
        <table id="inning-scores">
            <thead>
                <tr>
                    <th>Team</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th>
                    <th>8</th><th>9</th><th>10</th><th>11</th><th>12</th><th>13</th><th>14</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Team A</strong></td>
                    <td id="teamA-1">-</td><td id="teamA-2">-</td><td id="teamA-3">-</td><td id="teamA-4">-</td>
                    <td id="teamA-5">-</td><td id="teamA-6">-</td><td id="teamA-7">-</td><td id="teamA-8">-</td>
                    <td id="teamA-9">-</td><td id="teamA-10">-</td><td id="teamA-11">-</td><td id="teamA-12">-</td>
                    <td id="teamA-13">-</td><td id="teamA-14">-</td>
                </tr>
                <tr>
                    <td><strong>Team B</strong></td>
                    <td id="teamB-1">-</td><td id="teamB-2">-</td><td id="teamB-3">-</td><td id="teamB-4">-</td>
                    <td id="teamB-5">-</td><td id="teamB-6">-</td><td id="teamB-7">-</td><td id="teamB-8">-</td>
                    <td id="teamB-9">-</td><td id="teamB-10">-</td><td id="teamB-11">-</td><td id="teamB-12">-</td>
                    <td id="teamB-13">-</td><td id="teamB-14">-</td>
                </tr>
            </tbody>
        </table>
    </div>

<div class="inning-chart" style="margin-top: 40px;">
    <h3>Game Stats</h3>
    <table id="team-stats-table">
        <thead>
            <tr>
                <th>Team</th>
                <th>Runs</th>
                <th>AB</th>
                <th>H</th>
                <th>Avg</th>
                <th>RBI</th>
                <th>Def Att</th>
                <th>PO</th>
                <th>E</th>
                <th>Def %</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Team A</strong></td>
                <td id="stats-A-runs">0</td>
                <td id="stats-A-ab">0</td>
                <td id="stats-A-hits">0</td>
                <td id="stats-A-avg">.000</td>
                <td id="stats-A-rbi">0</td>
                <td id="stats-A-defatt">0</td>
                <td id="stats-A-po">0</td>
                <td id="stats-A-err">0</td>
                <td id="stats-A-defpct">.000</td>
            </tr>
            <tr>
                <td><strong>Team B</strong></td>
                <td id="stats-B-runs">0</td>
                <td id="stats-B-ab">0</td>
                <td id="stats-B-hits">0</td>
                <td id="stats-B-avg">.000</td>
                <td id="stats-B-rbi">0</td>
                <td id="stats-B-defatt">0</td>
                <td id="stats-B-po">0</td>
                <td id="stats-B-err">0</td>
                <td id="stats-B-defpct">.000</td>
            </tr>
        </tbody>
    </table>

    <div style="margin-top: 20px; padding: 15px; background: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,.1);">
        <h4>Homeruns</h4>
        <div id="homerun-list" style="font-size: 1.1em; line-height: 1.6;">
            None yet
        </div>
    </div>
</div>
    <div class="links">
        <a href="dartball_roster.html">Manage Roster</a> |
        <a href="dartball_lineup.html" target="_blank">Build Lineup</a> |
        <a href="dartball_plays_tracker.html">View Play Tracker</a> |
        <a href="scoresheet.html">View Scoresheet</a> |
        <a href="player_stats.html">View Player Stats</a>
    </div>

    <div id="clearModal" class="modal">
        <div class="modal-content">
            <h3>Clear Inning</h3>
            <p>Reset this inning?</p>
            <button type="button" class="confirm" onclick="confirmClear()">Yes</button>
            <button type="button" class="reset" onclick="cancelClear()">No</button>
        </div>
    </div>
    <div id="resetModal" class="modal">
        <div class="modal-content">
            <h3>New Game</h3>
            <p>Start a new game?</p>
            <button type="button" class="confirm" onclick="confirmReset()">Yes</button>
            <button type="button" class="reset" onclick="cancelReset()">No</button>
        </div>
    </div>
    <div id="newGameModal" class="modal">
        <div class="modal-content">
            <h3>New Game Options</h3>
            <p>Choose an action:</p>
            <button type="button" class="confirm" onclick="selectGameAction(1, 'start')">Start New Game 1</button>
            <button type="button" class="confirm" onclick="selectGameAction(2, 'start')">Start New Game 2</button>
            <button type="button" class="reset" onclick="selectGameAction(currentGame, 'reset')">Reset Current Game</button>
            <button type="button" class="reset" onclick="cancelNewGame()">Cancel</button>
        </div>
    </div>
    <div id="switchSidesModal" class="modal">
        <div class="modal-content">
            <h3>Choose Leadoff Team</h3>
            <p>Should Team B bat first?</p>
            <button type="button" class="confirm" onclick="confirmSwitchSides('B')">Yes</button>
            <button type="button" class="reset" onclick="confirmSwitchSides('A')">No</button>
        </div>
    </div>
    <div id="undoModal" class="modal">
        <div class="modal-content">
            <h3>Undo Last Play</h3>
            <p id="undoMessage">Undo the last action?</p>
            <button type="button" class="confirm" onclick="confirmUndo()">Yes</button>
            <button type="button" class="reset" onclick="cancelUndo()">No</button>
        </div>
    </div>
    <div id="alertModal" class="modal">
        <div class="modal-content">
            <h3>Notification</h3>
            <p id="alertMessage"></p>
            <button type="button" class="confirm" onclick="closeAlert()">OK</button>
        </div>
    </div>

    <script>
    let teamA = [];
    let teamB = [];
    let currentGame = 1;
    let currentState = {
        teamA: 0,
        teamB: 0,
        inning: 1,
        battingTeam: 'A',
        outs: 0,
        bases: {
            first: { occupied: false, player: '' },
            second: { occupied: false, player: '' },
            third: { occupied: false, player: '' }
        },
        batterIndex: 0,
        defenderIndex: 0,
        inningScores: Array(14).fill().map(() => ({ teamA: null, teamB: null })),
        plays: [],
        currentBalls: {},
        currentStrikes: {},
        leadoff: 'A',
        halfInningRuns: 0,
        awaitingDefender: false,
        batterDart: null
    };
    let inningStartState = JSON.parse(JSON.stringify(currentState));
    let stateHistory = [];
    let pendingPlay = null;
    const batterIndex = { A: 0, B: 0 };
    const defenderIndex = { A: 0, B: 0 };
    const ACTIVE_GAME_KEY = 'dartballActiveGame';   // ← ADD THIS LINE
    const LIVE_KEYS = ['current_game_lineup', 'current_lineup'];
    const EDITING_FLAG = 'dartball_editing_lineup';
    const PLAYS_KEY = () => `dartball_game${currentGame}_plays`;
    const STATE_KEY = () => `dartball_game${currentGame}_state`;
    const COMBINED_PLAYS_KEY = 'dartball_combined_plays';

    function teamSize(t) { return t === 'A' ? teamA.length : teamB.length; }
    function normalizePlayerEntry(x) {
        if (!x) return 'Player';
        if (typeof x === 'string') return x.trim();
        if (typeof x === 'object') {
            if (x.first || x.last) return `${(x.first || '').trim()} ${(x.last || '').trim()}`.trim();
            if (x.name) return x.name.trim();
            if (x.id) return String(x.id).trim();
        }
        return String(x).trim();
    }
    function escapeHtml(s) {
        return String(s || '')
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function hasRunners() {
        return currentState.bases.first.occupied || currentState.bases.second.occupied || currentState.bases.third.occupied;
    }

    function loadGameState() {
    if (resumeFromActiveGame()) return;  // ← This checks first!

    // Your normal saved game loading
    try {
        const saved = localStorage.getItem(STATE_KEY());
        if (saved) {
            currentState = JSON.parse(saved);
            batterIndex.A = currentState.batterIndex || 0;
            batterIndex.B = currentState.batterIndex || 0;
            defenderIndex.A = currentState.defenderIndex || 0;
            defenderIndex.B = currentState.defenderIndex || 0;
        } else {
            resetGameState();
        }
        const plays = localStorage.getItem(PLAYS_KEY());
        if (plays) currentState.plays = JSON.parse(plays);
    } catch (e) {
        console.error(e);
        resetGameState();
    }
    updateDisplay();
}
    function resetGameState() {
        currentState = {
            teamA: 0, teamB: 0, inning: 1, battingTeam: 'A', outs: 0,
            bases: { first: { occupied: false, player: '' }, second: { occupied: false, player: '' }, third: { occupied: false, player: '' } },
            batterIndex: 0, defenderIndex: 0,
            inningScores: Array(14).fill().map(() => ({ teamA: null, teamB: null })),
            plays: [], currentBalls: {}, currentStrikes: {}, leadoff: 'A',
            halfInningRuns: 0, awaitingDefender: false, batterDart: null
        };
        inningStartState = JSON.parse(JSON.stringify(currentState));
        batterIndex.A = 0; batterIndex.B = 0;
        defenderIndex.A = 0; defenderIndex.B = 0;
        stateHistory = [];
        pendingPlay = null;
    }

    function savePlays() {
        try {
            localStorage.setItem(PLAYS_KEY(), JSON.stringify(currentState.plays));
            updateCombinedPlays();
        } catch (e) {
            console.error('Failed to save plays:', e);
        }
    }

    function updateCombinedPlays() {
        try {
            const game1Plays = JSON.parse(localStorage.getItem('dartball_game1_plays') || '[]');
            const game2Plays = JSON.parse(localStorage.getItem('dartball_game2_plays') || '[]');
            const combinedPlays = [
                ...game1Plays.map(p => ({ ...p, game: 1 })),
                ...game2Plays.map(p => ({ ...p, game: 2 }))
            ];
            localStorage.setItem(COMBINED_PLAYS_KEY, JSON.stringify(combinedPlays));
        } catch (e) {
            console.error('Failed to update combined plays:', e);
        }
    }

    function registerPlayer(team, playerName) {
        try {
            const key = 'dartball_game_players';
            let registry = localStorage.getItem(key);
            registry = registry ? JSON.parse(registry) : { teamA: [], teamB: [] };
            const name = normalizePlayerEntry(playerName);
            if (team === 'A' && !registry.teamA.includes(name)) registry.teamA.push(name);
            if (team === 'B' && !registry.teamB.includes(name)) registry.teamB.push(name);
            localStorage.setItem(key, JSON.stringify(registry));
        } catch (e) {
            console.error('Failed to register player:', e);
        }
    }

    function updateDisplay() {
        const home = currentState.leadoff === 'B' ? 'B' : 'A';
        const away = home === 'A' ? 'B' : 'A';

        document.getElementById('teamA-score').textContent = home === 'A' ? currentState.teamA : currentState.teamB;
        document.getElementById('teamB-score').textContent = away === 'A' ? currentState.teamA : currentState.teamB;
        document.querySelector('.team-a .team-label').textContent = home === 'A' ? 'Team A' : 'Team B';
        document.querySelector('.team-b .team-label').textContent = home === 'A' ? 'Team B' : 'Team A';
        document.getElementById('inning').textContent = currentState.inning;
        document.getElementById('outs').textContent = currentState.outs;
        document.getElementById('half').textContent = currentState.battingTeam === currentState.leadoff ? 'Top' : 'Bottom';

        const batR = currentState.battingTeam === 'A' ? teamA : teamB;
        const defR = currentState.battingTeam === 'A' ? teamB : teamA;

        const batterName = batR[currentState.batterIndex] ? normalizePlayerEntry(batR[currentState.batterIndex]) : 'Player';
        const defenderName = defR[currentState.defenderIndex] ? normalizePlayerEntry(defR[currentState.defenderIndex]) : 'Player';

        document.getElementById('batter-name').textContent = batterName;
        document.getElementById('defender-name').textContent = defenderName;
        document.getElementById('batter-name').className = `player-name offense${currentState.awaitingDefender ? '' : ' active-player'}`;
        document.getElementById('defender-name').className = `player-name defense${currentState.awaitingDefender ? ' active-player' : ''}`;

        document.getElementById('batter-index').textContent = currentState.batterIndex + 1;
        document.getElementById('roster-size').textContent = batR.length || '-';
        document.getElementById('defender-index').textContent = currentState.defenderIndex + 1;
        document.getElementById('defender-roster-size').textContent = defR.length || '-';

        ['first', 'second', 'third'].forEach(b => {
            const el = document.getElementById(b);
            el.classList.toggle('occupied', currentState.bases[b].occupied);
            document.getElementById(`${b}-player`).textContent = currentState.bases[b].occupied ? currentState.bases[b].player || '' : '';
        });

        const runLabel = document.getElementById('home-runs');
        runLabel.textContent = currentState.halfInningRuns || 0;
        document.getElementById('home-plate').classList.toggle('scored', currentState.outs >= 3 && currentState.halfInningRuns > 0);

        const balls = Number(currentState.currentBalls[currentState.batterIndex] || 0);
        const strikes = Number(currentState.currentStrikes[currentState.batterIndex] || 0);
        document.getElementById('batter-meta').innerHTML = `
            <span class="team">${currentState.battingTeam}</span>
            <span class="status">At Bat</span>
            <span class="status meta-info">Ball ${balls}/4</span>
            <span class="status meta-info">Strike ${strikes}/3</span>`;
        document.getElementById('defender-meta').innerHTML = `<span class="team">${currentState.battingTeam === 'A' ? 'B' : 'A'}</span><span class="status">On Defense</span>`;

        const pp = document.getElementById('pending-play');
        if (pendingPlay) {
            let txt = pendingPlay.type;
            if (txt.startsWith('Defender')) txt = txt.replace('Defender', 'Defender: ');
            else txt = `Batter: ${txt}`;
            pp.textContent = `Pending: ${txt.replace(/([A-Z])/g, ' $1').trim()}`;
            pp.style.display = 'block';
        } else pp.style.display = 'none';

        document.getElementById('batter-controls').style.display = currentState.awaitingDefender ? 'none' : 'grid';
        document.getElementById('defender-controls').style.display = currentState.awaitingDefender ? 'grid' : 'none';

       updateInningChart();
    calculateTeamStats();   // ← NEW

    }

    function getHomeTeam() { return currentState.leadoff === 'B' ? 'B' : 'A'; }
    function getAwayTeam() { return getHomeTeam() === 'A' ? 'B' : 'A'; }

    function updateInningChart() {
        const home = getHomeTeam();
        const away = getAwayTeam();
        for (let i = 0; i < 14; i++) {
            const homeScore = home === 'A' ? currentState.inningScores[i].teamA : currentState.inningScores[i].teamB;
            const awayScore = away === 'A' ? currentState.inningScores[i].teamA : currentState.inningScores[i].teamB;
            document.getElementById(`teamA-${i+1}`).textContent = homeScore !== null ? homeScore : '-';
            document.getElementById(`teamB-${i+1}`).textContent = awayScore !== null ? awayScore : '-';
        }
        document.querySelector('.inning-chart tbody tr:nth-child(1) td strong').textContent = `Team ${home}`;
        document.querySelector('.inning-chart tbody tr:nth-child(2) td strong').textContent = `Team ${away}`;
    }

    function saveState() {
        stateHistory.push(JSON.parse(JSON.stringify(currentState)));
        if (stateHistory.length > 20) stateHistory.shift();
        try { localStorage.setItem(STATE_KEY(), JSON.stringify(currentState)); } catch (e) {}
    }

    function showUndoModal() {
        if (!stateHistory.length) return showAlert('Nothing to undo');
        const lastPlay = currentState.plays[currentState.plays.length - 1];
        const preview = lastPlay ? `${lastPlay.playType} — ${lastPlay.player}` : 'Previous state';
        document.getElementById('undoMessage').textContent = `Undo: ${preview}?`;
        document.getElementById('undoModal').style.display = 'flex';
    }

    function confirmUndo() {
        if (stateHistory.length) {
            currentState = stateHistory.pop();
            pendingPlay = null;
            savePlays();
            updateDisplay();
            showAlert('Undone!');
        }
        document.getElementById('undoModal').style.display = 'none';
    }

    function cancelUndo() { document.getElementById('undoModal').style.display = 'none'; }

    function queuePlay(t) {
        if (currentState.awaitingDefender && !t.startsWith('Defender')) return showAlert('Select defender play first');
        if (!currentState.awaitingDefender && t.startsWith('Defender')) return showAlert('Select batter play first');
        pendingPlay = { type: t };
        updateDisplay();
    }

   function confirmPlay() {
    if (!pendingPlay) return showAlert('No play selected');
    if (!teamA.length && !teamB.length) return showAlert('Load lineup first');
    saveState();

    const batTeam = currentState.battingTeam;
    const batR = batTeam === 'A' ? teamA : teamB;
    const defR = batTeam === 'A' ? teamB : teamA;
    const batter = normalizePlayerEntry(batR[currentState.batterIndex]) || 'Player';
    const defender = normalizePlayerEntry(defR[currentState.defenderIndex]) || 'Player';
    const play = pendingPlay.type;

    let advanceBatterFlag = false;
    let playCode = '';
    let runsScored = 0;
    let rbi = 0;

    if (['1st', '2nd', '3rd', 'HR', 'H&R'].includes(play)) {
        const basesToMove = play === '1st' ? 1 :
                           play === '2nd' || play === 'H&R' ? 2 :
                           play === '3rd' ? 3 : 4;

        let newBases = {
            first:  { occupied: false, player: '' },
            second: { occupied: false, player: '' },
            third:  { occupied: false, player: '' }
        };

        // Count RBI
        if (currentState.bases.third.occupied && basesToMove >= 1) rbi++;
        if (currentState.bases.second.occupied && basesToMove >= 2) rbi++;
        if (currentState.bases.first.occupied && basesToMove >= 3) rbi++;
        if (play === 'HR') rbi++;  // batter scores

    

        // ADVANCE ALL RUNNERS — FIXED!
        if (currentState.bases.third.occupied) {
            if (basesToMove >= 1) runsScored++;
            else newBases.third = { occupied: true, player: currentState.bases.third.player };
        }
        if (currentState.bases.second.occupied) {
            if (basesToMove >= 2) runsScored++;
            else if (basesToMove === 1) newBases.third = { occupied: true, player: currentState.bases.second.player };
            else newBases.second = { occupied: true, player: currentState.bases.second.player };
        }
        if (currentState.bases.first.occupied) {
            if (basesToMove >= 3) runsScored++;
            else if (basesToMove >= 2) newBases.third = { occupied: true, player: currentState.bases.first.player };
            else if (basesToMove === 1) newBases.second = { occupied: true, player: currentState.bases.first.player };
            else newBases.first = { occupied: true, player: currentState.bases.first.player };
        }

        // Place batter
     

        if (play === 'HR') {
            runsScored++;  // batter scores
            playCode = '4';
        } else if (play === '3rd') {
            newBases.third = { occupied: true, player: batter };
            playCode = '3';
        } else if (play === '2nd' || play === 'H&R') {
            newBases.second = { occupied: true, player: batter };
            playCode = play === '2nd' ? '2' : '5';
        } else if (play === '1st') {
            newBases.first = { occupied: true, player: batter };
            playCode = '1';
        }

        currentState.bases = newBases;
        currentState.halfInningRuns += runsScored;
        currentState[batTeam === 'A' ? 'teamA' : 'teamB'] += runsScored;

        currentState.plays.push({
            inning: currentState.inning,
            team: batTeam,
            player: batter,
            playType: playCode,
            rbi: rbi,
            runs: runsScored,
            timestamp: Date.now()
        });

        advanceBatterFlag = true;
        currentState.currentBalls[currentState.batterIndex] = 0;
        currentState.currentStrikes[currentState.batterIndex] = 0;

} else if (play === 'Ball') {
    currentState.currentBalls[currentState.batterIndex] = (currentState.currentBalls[currentState.batterIndex] || 0) + 1;

    if (currentState.currentBalls[currentState.batterIndex] >= 4) {
        let newBases = JSON.parse(JSON.stringify(currentState.bases));
        let runsScored = 0;

        // Only force runners if first base is occupied
        if (newBases.first.occupied) {

            // 1. Runner on 3rd scores
            if (newBases.third.occupied) {
                runsScored = 1;
            }

            // 2. Runner on 2nd → 3rd (this preserves a2!)
            if (newBases.second.occupied) {
                newBases.third = { occupied: true, player: newBases.second.player };  // a2 → 3rd
            } else {
                newBases.third = { occupied: false, player: '' };
            }

            // 3. Runner on 1st → 2nd
            newBases.second = { occupied: true, player: newBases.first.player };  // a3 → 2nd
        }

        // 4. Batter goes to 1st
 
        newBases.first = { occupied: true, player: batter };

        // DO NOT clear third unless it was empty after shift
        // → We already correctly placed runner from 2nd there

        currentState.bases = newBases;
        currentState.halfInningRuns += runsScored;
        currentState[batTeam === 'A' ? 'teamA' : 'teamB'] += runsScored;

        currentState.plays.push({
            inning: currentState.inning,
            team: batTeam,
            player: batter,
            playType: 'BB',
            rbi: runsScored > 0 ? 1 : 0,
            runs: runsScored,
            atBat: true,
            hit: true,
            timestamp: Date.now()
        });

        advanceBatterFlag = true;
        currentState.currentBalls[currentState.batterIndex] = 0;
        currentState.currentStrikes[currentState.batterIndex] = 0;
    }


    } else if (play === 'Green') {
        currentState.currentStrikes[currentState.batterIndex] = (currentState.currentStrikes[currentState.batterIndex] || 0) + 1;
        if (currentState.currentStrikes[currentState.batterIndex] >= 3) {
            currentState.outs++;
            advanceBatterFlag = true;
            currentState.currentBalls[currentState.batterIndex] = 0;
            currentState.currentStrikes[currentState.batterIndex] = 0;
            currentState.plays.push({ inning: currentState.inning, team: batTeam, player: batter, playType: 'SKO', timestamp: Date.now() });
        }
    } else if (play === 'Red') {
        currentState.outs++;
        advanceBatterFlag = true;
        currentState.currentBalls[currentState.batterIndex] = 0;
        currentState.currentStrikes[currentState.batterIndex] = 0;
        currentState.plays.push({ inning: currentState.inning, team: batTeam, player: batter, playType: 'O', timestamp: Date.now() });
    } else if (play === 'Blue' || play === 'Yellow') {
        currentState.batterDart = play;
        if (currentState.currentStrikes[currentState.batterIndex] >= 2) {
            currentState.outs++;
            advanceBatterFlag = true;
            currentState.currentBalls[currentState.batterIndex] = 0;
            currentState.currentStrikes[currentState.batterIndex] = 0;
            currentState.plays.push({ inning: currentState.inning, team: batTeam, player: batter, playType: 'SKO', timestamp: Date.now() });
        } else {
            currentState.awaitingDefender = true;
        }
} else if (play.startsWith('Defender')) {
    const defDart = play.replace('Defender', '');
    const strikes = currentState.currentStrikes[currentState.batterIndex] || 0;
    let defCode = '';

    if (currentState.batterDart === 'Blue') {
        if (defDart === 'Blue' || defDart === 'Yellow') {
            currentState.outs++;
            defCode = 'SPO';
            advanceBatterFlag = true;           // out → batter advances
        }
        else if (defDart === 'Miss') {
            currentState.currentStrikes[currentState.batterIndex] = strikes + 1;
            defCode = strikes + 1 >= 3 ? 'SKO' : 'E';
            if (strikes + 1 >= 3) {
                currentState.outs++;
                advanceBatterFlag = true;       // 3rd strike → out → batter advances
                currentState.currentBalls[currentState.batterIndex] = 0;
                currentState.currentStrikes[currentState.batterIndex] = 0;
            }
            // else: just a strike → NO advanceBatterFlag!
        }
    } 
    else if (currentState.batterDart === 'Yellow') {
        if (defDart === 'Yellow' && hasRunners() && currentState.outs < 2) {
            currentState.outs += 2;
            removeRunnerClosestToHome();
            defCode = 'DPO';
            advanceBatterFlag = true;           // double play → batter out
        }
        else if (defDart === 'Yellow' || defDart === 'Blue') {
            currentState.outs++;
            defCode = 'SPO';
            advanceBatterFlag = true;           // single play out
        }
        else if (defDart === 'Miss') {
            currentState.currentStrikes[currentState.batterIndex] = strikes + 1;
            defCode = strikes + 1 >= 3 ? 'SKO' : 'E';
            if (strikes + 1 >= 3) {
                currentState.outs++;
                advanceBatterFlag = true;
                currentState.currentBalls[currentState.batterIndex] = 0;
                currentState.currentStrikes[currentState.batterIndex] = 0;
            }
        }
    }

    // Record the play
    currentState.plays.push({
        inning: currentState.inning,
        team: batTeam,
        player: batter,
        defender: defender,
        playType: currentState.batterDart === 'Blue' ? 'S' : 'Y',
        defenderPlayType: defCode,
        timestamp: Date.now()
    });

    // ALWAYS advance defender — they threw the dart!
    advanceDefender();

    // Reset defender mode
    currentState.awaitingDefender = false;
    currentState.batterDart = null;

    // DO NOT TOUCH advanceBatterFlag here — it's already set correctly above
}

    if (currentState.outs >= 3) endHalfInning();
    if (advanceBatterFlag) advanceBatter();

    savePlays();
    pendingPlay = null;
    updateDisplay();
}

    function removeRunnerClosestToHome() {
        if (currentState.bases.third.occupied) currentState.bases.third = { occupied: false, player: '' };
        else if (currentState.bases.second.occupied) currentState.bases.second = { occupied: false, player: '' };
        else if (currentState.bases.first.occupied) currentState.bases.first = { occupied: false, player: '' };
    }

    function endHalfInning() {
    const idx = currentState.inning - 1;
    const teamJustBatted = currentState.battingTeam;
    const isTop = teamJustBatted === currentState.leadoff;
    const home = getHomeTeam();

    // ONLY RECORD THE INNING TOTAL — DO NOT ADD TO TEAM SCORE AGAIN!
    if (isTop) {
        currentState.inningScores[idx][home === 'A' ? 'teamA' : 'teamB'] = currentState.halfInningRuns;
    } else {
        currentState.inningScores[idx][home === 'A' ? 'teamB' : 'teamA'] = currentState.halfInningRuns;
    }

    setTimeout(() => {
        currentState.outs = 0;
        currentState.bases = {
            first: { occupied: false, player: '' },
            second: { occupied: false, player: '' },
            third: { occupied: false, player: '' }
        };
        currentState.currentBalls = {};
        currentState.currentStrikes = {};
        currentState.halfInningRuns = 0;
        currentState.battingTeam = currentState.battingTeam === 'A' ? 'B' : 'A';
        if (currentState.battingTeam === currentState.leadoff) {
            currentState.inning++;
        }
        currentState.batterIndex = batterIndex[currentState.battingTeam];
        currentState.defenderIndex = defenderIndex[currentState.battingTeam === 'A' ? 'B' : 'A'];
        currentState.awaitingDefender = false;
        currentState.batterDart = null;
        inningStartState = JSON.parse(JSON.stringify(currentState));
        savePlays();
        updateDisplay();
    }, 500);
}

    function advanceBatter() {
        const team = currentState.battingTeam;
        const size = teamSize(team);
        if (size === 0) return;
        batterIndex[team] = (batterIndex[team] + 1) % size;
        currentState.batterIndex = batterIndex[team];
        currentState.currentBalls[currentState.batterIndex] = 0;
        currentState.currentStrikes[currentState.batterIndex] = 0;
    }

    function nextBatter() { saveState(); advanceBatter(); pendingPlay = null; updateDisplay(); }
    function prevBatter() {
        saveState();
        const team = currentState.battingTeam;
        const size = teamSize(team);
        if (size === 0) return;
        batterIndex[team] = (batterIndex[team] - 1 + size) % size;
        currentState.batterIndex = batterIndex[team];
        pendingPlay = null;
        updateDisplay();
    }
    function advanceDefender() {
        const defTeam = currentState.battingTeam === 'A' ? 'B' : 'A';
        const size = teamSize(defTeam);
        if (size === 0) return;
        defenderIndex[defTeam] = (defenderIndex[defTeam] + 1) % size;
        currentState.defenderIndex = defenderIndex[defTeam];
    }
    function nextDefender() { saveState(); advanceDefender(); updateDisplay(); }
    function prevDefender() {
        saveState();
        const defTeam = currentState.battingTeam === 'A' ? 'B' : 'A';
        const size = teamSize(defTeam);
        if (size === 0) return;
        defenderIndex[defTeam] = (defenderIndex[defTeam] - 1 + size) % size;
        currentState.defenderIndex = defenderIndex[defTeam];
        updateDisplay();
    }

    // Rest of your functions (modals, lineup, etc.) remain unchanged...
    function showClearModal() { document.getElementById('clearModal').style.display = 'flex'; }
    function confirmClear() {
        saveState();
        currentState.outs = currentState.bases = currentState.currentBalls = currentState.currentStrikes = {};
        currentState.halfInningRuns = 0; currentState.awaitingDefender = false; currentState.batterDart = null;
        pendingPlay = null;
        updateDisplay();
        document.getElementById('clearModal').style.display = 'none';
        showAlert('Inning cleared');
    }
    function cancelClear() { document.getElementById('clearModal').style.display = 'none'; }
    function showResetModal() { document.getElementById('resetModal').style.display = 'flex'; }
    function confirmReset() {
    localStorage.removeItem(ACTIVE_GAME_KEY);  // ← Clears any old resume data

    document.getElementById('resetModal').style.display = 'none';
    document.getElementById('newGameModal').style.display = 'flex';
}
    function selectGameAction(g, a) {
        if (a === 'reset' && !confirm(`Reset Game ${g}?`)) return;
        currentGame = g;
        document.getElementById('gameSelect').value = g;
        document.getElementById('newGameModal').style.display = 'none';
        document.getElementById('switchSidesModal').style.display = 'flex';
    }
    function confirmSwitchSides(t) {
        resetGameState();
        currentState.battingTeam = currentState.leadoff = t;
        try { localStorage.removeItem(PLAYS_KEY()); localStorage.removeItem(STATE_KEY()); } catch (e) {}
        updateCombinedPlays();
        updateDisplay();
        document.getElementById('switchSidesModal').style.display = 'none';
        showAlert(`New Game ${currentGame} – Team ${t} bats first`);
    }
    function cancelNewGame() { document.getElementById('newGameModal').style.display = 'none'; }
    function cancelReset() { document.getElementById('resetModal').style.display = 'none'; }
    function showAlert(m) {
        document.getElementById('alertMessage').textContent = m;
        document.getElementById('alertModal').style.display = 'flex';
    }
    function closeAlert() { document.getElementById('alertModal').style.display = 'none'; }

   function editLineup() {
    // Save the EXACT current game state before editing lineup
    const save = {
        teamA: teamA.map(p => ({...p})),
        teamB: teamB.map(p => ({...p})),
        batterA: batterIndex.A,
        batterB: batterIndex.B,
        defenderA: defenderIndex.A,
        defenderB: defenderIndex.B,
        leadoff: currentState.leadoff,
        battingTeam: currentState.battingTeam,
        inning: currentState.inning,
        outs: currentState.outs,
        halfInningRuns: currentState.halfInningRuns,
        bases: JSON.parse(JSON.stringify(currentState.bases)),
        scoreA: currentState.teamA,
        scoreB: currentState.teamB,
        inningScores: currentState.inningScores.map(s => ({...s})),
        currentBalls: {...currentState.currentBalls},
        currentStrikes: {...currentState.currentStrikes},
        plays: currentState.plays.slice()
    };
    localStorage.setItem(ACTIVE_GAME_KEY, JSON.stringify(save));
    window.open('dartball_lineup.html?editing=true', '_blank');
}
// RESUME FROM LINEUP EDIT — THIS IS THE MAGIC
function resumeFromActiveGame() {
    const data = localStorage.getItem(ACTIVE_GAME_KEY);
    if (!data) return false;

    try {
        const s = JSON.parse(data);

        // Restore lineups
        teamA = s.teamA || [];
        teamB = s.teamB || [];

        // Restore indices safely (clamp if player was removed)
        batterIndex.A   = Math.min(s.batterA   || 0, Math.max(0, teamA.length - 1));
        batterIndex.B   = Math.min(s.batterB   || 0, Math.max(0, teamB.length - 1));
        defenderIndex.A = Math.min(s.defenderA || 0, Math.max(0, teamA.length - 1));
        defenderIndex.B = Math.min(s.defenderB || 0, Math.max(0, teamB.length - 1));

        // Restore all game state
        Object.assign(currentState, {
            leadoff: s.leadoff || 'A',
            battingTeam: s.battingTeam || 'A',
            inning: s.inning || 1,
            outs: s.outs || 0,
            halfInningRuns: s.halfInningRuns || 0,
            bases: s.bases || {first:{occupied:false,player:''}, second:{occupied:false,player:''}, third:{occupied:false,player:''}},
            teamA: s.scoreA || 0,
            teamB: s.scoreB || 0,
            inningScores: s.inningScores || Array(14).fill().map(()=>({teamA:null,teamB:null})),
            currentBalls: s.currentBalls || {},
            currentStrikes: s.currentStrikes || {},
            plays: s.plays || []
        });

        currentState.batterIndex = batterIndex[currentState.battingTeam];
        currentState.defenderIndex = defenderIndex[currentState.battingTeam === 'A' ? 'B' : 'A'];

        localStorage.removeItem(ACTIVE_GAME_KEY);
        updateDisplay();
        showAlert('Lineup updated — game resumed exactly where you left off!');
        return true;
    } catch (e) {
        console.error('Resume failed:', e);
        localStorage.removeItem(ACTIVE_GAME_KEY);
        showAlert('Error resuming game.');
        return false;
    }
}


    function parseStoredLiveLineup(raw) {
        if (!raw) return null;
        let obj;
        try { obj = JSON.parse(raw); } catch { return null; }
        const norm = arr => Array.isArray(arr) ? arr.map(normalizePlayerEntry) : [];
        return {
            teamA: norm(obj.teamA || obj.team_a || []),
            teamB: norm(obj.teamB || obj.team_b || []),
            leadoff: obj.leadoff || obj.leadOff || 'A',
            gameNumber: obj.gameNumber
        };
    }

    function applyLiveLineup(l) {
        if (!l) return;
        teamA = (l.teamA || []).slice();
        teamB = (l.teamB || []).slice();
        batterIndex.A = batterIndex.B = defenderIndex.A = defenderIndex.B = 0;
        currentState.leadoff = l.leadoff === 'B' ? 'B' : 'A';
        currentState.battingTeam = currentState.inning === 1 ? currentState.leadoff : currentState.battingTeam;
        currentState.bases = { first: { occupied: false, player: '' }, second: { occupied: false, player: '' }, third: { occupied: false, player: '' } };
        currentState.currentBalls = {}; currentState.currentStrikes = {}; currentState.halfInningRuns = 0;
        currentState.awaitingDefender = false; currentState.batterDart = null;
        currentState.batterIndex = batterIndex[currentState.battingTeam];
        currentState.defenderIndex = defenderIndex[currentState.battingTeam === 'A' ? 'B' : 'A'];
        updateDisplay();
        try { localStorage.removeItem(EDITING_FLAG); } catch (e) {}
    }

    function loadLineup() {
        let saved = null;
        for (const k of LIVE_KEYS) {
            try { saved = localStorage.getItem(k); if (saved) break; } catch (e) {}
        }
        if (!saved) return showAlert('No lineup found.');
        const live = parseStoredLiveLineup(saved);
        if (!live || (!live.teamA.length && !live.teamB.length)) return showAlert('Invalid lineup.');
        if (live.gameNumber && Number(live.gameNumber) !== currentGame) {
            if (!confirm(`Lineup is for Game ${live.gameNumber}. Load anyway?`)) return;
        }
        applyLiveLineup(live);
        showAlert(`Lineup loaded for Game ${currentGame}`);
    }

    document.getElementById('gameSelect').addEventListener('change', e => {
        const newGame = Number(e.target.value);
        const hasData = localStorage.getItem(`dartball_game${newGame}_plays`) || localStorage.getItem(`dartball_game${newGame}_state`);
        if (hasData && !confirm(`Game ${newGame} has data. Load it?`)) {
            e.target.value = currentGame;
            return;
        }
        currentGame = newGame;
        loadGameState();
    });

    window.onload = () => {
    loadGameState();
    calculateTeamStats();   // ensures stats show even on fresh load/resume
};

// =======================
// LIVE TEAM & PLAYER STATS
// =======================

function calculateTeamStats() {
    const stats = {
        A: { runs: 0, ab: 0, hits: 0, rbi: 0, defAttempts: 0, putouts: 0, errors: 0, hrs: [] },
        B: { runs: 0, ab: 0, hits: 0, rbi: 0, defAttempts: 0, putouts: 0, errors: 0, hrs: [] }
    };

    currentState.plays.forEach(p => {
        const team = p.team;

        // Runs scored in this play
        if (p.runs) stats[team].runs += p.runs;

        // At-bats & hits
        if (p.atBat || ['1','2','3','4','5','BB','O','SKO','SPO','DPO'].includes(p.playType)) {
            stats[team].ab++;
            if (['1','2','3','4','5','BB'].includes(p.playType)) stats[team].hits++;
        }

        // RBI
        if (p.rbi) stats[team].rbi += p.rbi;

        // Defense (only when there is a defender play)
        if (p.defenderPlayType) {
            const defTeam = team === 'A' ? 'B' : 'A';
            stats[defTeam].defAttempts++;
            if (['SPO','DPO'].includes(p.defenderPlayType)) stats[defTeam].putouts += (p.defenderPlayType === 'DPO' ? 2 : 1);
            if (p.defenderPlayType === 'E') stats[defTeam].errors++;
        }

        // Homeruns
        if (p.playType === '4') {
            stats[team].hrs.push(p.player);
        }
    });

    // Update Team A row
    document.getElementById('stats-A-runs').textContent = stats.A.runs;
    document.getElementById('stats-A-ab').textContent = stats.A.ab;
    document.getElementById('stats-A-hits').textContent = stats.A.hits;
    document.getElementById('stats-A-rbi').textContent = stats.A.rbi;
    document.getElementById('stats-A-defatt').textContent = stats.A.defAttempts;
    document.getElementById('stats-A-po').textContent = stats.A.putouts;
    document.getElementById('stats-A-err').textContent = stats.A.errors;

    const avgA = stats.A.ab > 0 ? (stats.A.hits / stats.A.ab) : 0;
    const defPctA = stats.A.defAttempts > 0 ? (stats.A.putouts / stats.A.defAttempts) : 0;
    document.getElementById('stats-A-avg').textContent = avgA.toFixed(3).replace(/^0/, '');
    document.getElementById('stats-A-defpct').textContent = defPctA.toFixed(3).replace(/^0/, '');

    // Update Team B row
    document.getElementById("stats-B-runs").textContent = stats.B.runs;
    document.getElementById('stats-B-ab').textContent = stats.B.ab;
    document.getElementById('stats-B-hits').textContent = stats.B.hits;
    document.getElementById('stats-B-rbi').textContent = stats.B.rbi;
    document.getElementById('stats-B-defatt').textContent = stats.B.defAttempts;
    document.getElementById('stats-B-po').textContent = stats.B.putouts;
    document.getElementById('stats-B-err').textContent = stats.B.errors;

     const avgB = stats.B.ab > 0 ? (stats.B.hits / stats.B.ab) : 0;
    const defPctB = stats.B.defAttempts > 0 ? (stats.B.putouts / stats.B.defAttempts) : 0;
    document.getElementById('stats-B-avg').textContent = avgB.toFixed(3).replace(/^0/, '');
    document.getElementById('stats-B-defpct').textContent = defPctB.toFixed(3).replace(/^0/, '');

    // Homerun list
    const allHR = [...stats.A.hrs, ...stats.B.hrs];
    const hrEl = document.getElementById('homerun-list');
    if (allHR.length === 0) {
        hrEl.textContent = 'None yet';
    } else {
        hrEl.innerHTML = allHR.map((name, i) => `${i+1}. ${escapeHtml(name)}`).join('<br>');
    }
}
</script>
</body>
</html>
